<GridX fullscreen>
    <CardForm ref:root caption="Starting facility">
        <SelectBox ref:app caption="Select app" blank wide>
            <SelectItem caption="system"></SelectItem>
            {{#for app in get_apps()}}
            <SelectItem caption="{app}"></SelectItem>
            {{/for}}
        </SelectBox>
        <SelectBox ref:user caption="Select user" blank wide>
            {{#for user in get_users()}}
            <SelectItem caption="{user}"></SelectItem>
            {{#else}}
            <option disabled>no users available</option>
            {{/for}}
        </SelectBox>
        {{#if not get_users_count()}}
        <InputBox caption="Create new admin user">
            <InputText ref:login caption="Login" required></InputText>
            <InputPassword ref:passw caption="Password" required></InputPassword>
            <InputPassword ref:passw2 caption="Password again" required></InputPassword>
            <GridX>
                <Button default action="create_first_admin" caption="Create and login"></Button>
            </GridX>
        </InputBox>
        {{#else}}
        <InputPassword ref:password caption="Password"></InputPassword>
        <GridX>
            <Button default action="login" caption="Login"></Button>
        </GridX>
        {{/if}}
    </CardForm>
</GridX>

<python>
from pony.orm import db_session
from db.models import User
from core.ctx import *

@db_session
def get_users_count():
    return User.select().count()

def get_apps():
    return ctx.session.get_apps()

@db_session
def get_users():
    for user in User.select():
        yield user.name

def create_first_admin(node):
    ok = True
    ok &= refs.login.validate()
    ok &= refs.passw.validate()
    ok &= refs.passw2.validate(refs.passw.value == refs.passw2.value, "Passwords don't match")
    if ok:
        with db_session:
            admin = User(name = refs.login.value, is_admin=True)
            admin.set_password(refs.passw.value)
        refs.root.update_tree()

@db_session
def login(node):
    username = refs.user.value
    user = User.get(name=username)
    refs.user.error = 'User not available'

</python>