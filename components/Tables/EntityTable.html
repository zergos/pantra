<reuse template="Table"/>

<python>
from pony.orm.core import Query, Entity, db_session, desc
from core.models import query_info
from core.common import WebUnits
from components.Tables import Columns, ColumnInfo
from core.ctx import *

query: Optional[Query] = None
entity: Entity
col_id: str = "id"

columns: Columns = {}

def init():
    global query, columns
    # default query
    if query is None:
        with db_session():
            query = entity.select()

    # detect types
    info = query_info(query)
    if not info:
        return

    for name, attr in info.items():
        col = ColumnInfo(name=name, type=attr.type, title=attr.title or name, editable=not attr.readonly)
        if attr.width:
            col.style.width = WebUnits(attr.width, 'em')
        columns[name] = col

@db_session
def get_rows(order_col, order_dir):
    if order_col:
        col = getattr(entity, order_col)
        if order_dir<0:
            col = desc(col)
        q = query.order_by(col)
    else:
        q = query
    for row in q:
        yield row.to_dict()

@db_session
def save_value(field: Context, value):
    col = field.column

    entity[field.scope.row_id].set(**{col.name: value})

</python>